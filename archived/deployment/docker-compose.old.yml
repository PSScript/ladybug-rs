# =============================================================================
# Docker Compose for Ladybug-RS Local Development & Production
# =============================================================================
#
# Usage:
#   docker-compose up              # Start with default settings
#   docker-compose up --build      # Rebuild and start
#   docker-compose up -d           # Start in background
#   docker-compose logs -f         # Follow logs
#   docker-compose down            # Stop and remove
#
# Profiles:
#   docker-compose --profile avx512 up    # Use AVX-512 optimized build (Railway)
#   docker-compose --profile claude up    # Claude backend mode (localhost)
#   docker-compose --profile dev up       # Development with hot reload
#
# Endpoints after startup:
#   http://localhost:8080/health   - Health check
#   http://localhost:8080/metrics  - Prometheus metrics
#   http://localhost:8080/info     - Server info
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Main Ladybug-RS Server (auto-detect CPU features)
  # ---------------------------------------------------------------------------
  ladybug:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        TARGET_CPU: native
        FEATURES: "simd,parallel,codebook,hologram,quantum,spo"
    container_name: ladybug-rs
    ports:
      - "8080:8080"
    volumes:
      - ladybug-data:/data
    environment:
      - HOST=0.0.0.0
      - PORT=8080
      - DATA_DIR=/data
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ---------------------------------------------------------------------------
  # AVX-512 Optimized (for Railway/modern servers with AVX-512)
  # ---------------------------------------------------------------------------
  ladybug-avx512:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime-avx512
    container_name: ladybug-rs-avx512
    profiles:
      - avx512
      - railway
    ports:
      - "8080:8080"
    volumes:
      - ladybug-data:/data
    environment:
      - HOST=0.0.0.0
      - PORT=8080
      - DATA_DIR=/data
      - RUST_LOG=info
      - RAILWAY_ENVIRONMENT=production
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # ---------------------------------------------------------------------------
  # Claude Backend Mode (localhost-bound, port 5000)
  # ---------------------------------------------------------------------------
  ladybug-claude:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime-claude
    container_name: ladybug-rs-claude
    profiles:
      - claude
    ports:
      - "5000:5000"
    volumes:
      - ladybug-data:/data
    environment:
      - HOST=127.0.0.1
      - PORT=5000
      - DATA_DIR=/data
      - RUST_LOG=info
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:5000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Development mode (mount source for iteration)
  # ---------------------------------------------------------------------------
  ladybug-dev:
    image: rust:1.76-bookworm
    container_name: ladybug-rs-dev
    profiles:
      - dev
    working_dir: /app
    volumes:
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
      - ladybug-data:/data
    ports:
      - "8080:8080"
    environment:
      - HOST=0.0.0.0
      - PORT=8080
      - DATA_DIR=/data
      - RUST_LOG=debug
      - CARGO_TARGET_DIR=/app/target
    command: >
      bash -c "
        apt-get update && apt-get install -y cmake pkg-config libssl-dev curl &&
        cargo build --release --bin ladybug-server --features 'simd,parallel,codebook,hologram,quantum,spo' &&
        ./target/release/ladybug-server
      "
    restart: unless-stopped

volumes:
  ladybug-data:
    name: ladybug-data
  cargo-cache:
    name: ladybug-cargo-cache
  target-cache:
    name: ladybug-target-cache

networks:
  default:
    name: ladybug-network
